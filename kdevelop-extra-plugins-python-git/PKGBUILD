# Contributor: mosra <mosra@centrum.cz>

pkgname=kdevelop-extra-plugins-python-git
pkgver=20110319
pkgrel=1
pkgdesc="A Python plugin for KDevelop - GIT build"
arch=('i686' 'x86_64')
url="https://projects.kde.org/projects/playground/devtools/plugins/kdev-python"
license=('GPL')
groups=('kde' 'kdevelop-extra-plugins')
depends=('kdevelop-git')
makedepends=('cmake' 'automoc4' 'git' 'kdevelop-pg-qt-git')
provides=('kdevelop-python')
conflicts=('kdevelop-python')
source=('build.patch')
md5sums=('bdc2f6871e8da678252ba5db731e301c')

_gitroot="git://anongit.kde.org/kdev-python"
_gitname="python"

build() {
    cd "${srcdir}"
    msg "Connecting to GIT server...."

    if [ -d "${_gitname}" ] ; then
        cd "${_gitname}"

        # Change remote url to anongit
        if [ -z $(git branch -v | grep anongit) ] ; then
            git remote set-url origin ${_gitroot}
        fi

        git checkout .
        git pull origin
        msg "The local files are updated."
    else
        git clone "${_gitroot}" "${_gitname}"
    fi

    # Build fixes
    git apply ${srcdir}/build.patch

    msg "GIT checkout done or server timeout"
    msg "Starting make..."

    mkdir -p "${srcdir}/build"
    cd "${srcdir}/build"

    cmake "../${_gitname}" \
        -DCMAKE_SKIP_RPATH=ON \
        -DCMAKE_BUILD_TYPE=RELWITHDEBINFO \
        -DCMAKE_{SHARED,MODULE,EXE}_LINKER_FLAGS='-Wl,--no-undefined -Wl,--as-needed' \
        -DCMAKE_INSTALL_PREFIX=/usr || return 1

    make || return 1
    make DESTDIR="${pkgdir}" install || return 1
}
