#!/bin/bash

. /etc/rc.conf
. /etc/rc.d/functions
. /etc/conf.d/vbox

if [[ -n "$INSTALL_DIR" ]]; then
  VBOXMANAGE="$INSTALL_DIR/VBoxManage"
  BUILDVBOXDRV="$INSTALL_DIR/src/vboxhost/vboxdrv/build_in_tmp"
  BUILDVBOXNETFLT="$INSTALL_DIR/src/vboxhost/vboxnetflt/build_in_tmp"
  BUILDVBOXNETADP="$INSTALL_DIR/src/vboxhost/vboxnetadp/build_in_tmp"
else
  echo "Missing vbox config file"
  exit 0
fi

load() {
  if [[ "$START_BUILD" =~ yes|YES ]]; then
    # check if module exists
    c=$(find /lib/modules/`uname -r` -name "vbox*" 2>/dev/null | wc -l)
    [[ $c -eq 0 ]] && setup
  fi
  stat_busy "Loading VirtualBox kernel modules"
  # trivial loading
  for module in vbox{netflt,netadp,drv}; do
      modprobe $module &>/dev/null
  done
  # check
  for module in vbox{netflt,netadp,drv}; do
    if ! grep -q "^${module}" /proc/modules; then
      stat_fail
      return 1
    fi
  done
  stat_done
}

unload() {
  stat_busy "Unloading VirtualBox kernel modules"
  # trivial unload
  for module in vbox{netflt,netadp,drv}; do
    if grep -q "^${module}" /proc/modules; then
      modprobe -r $module &>/dev/null
    fi
  done
  # check
  for module in vbox{netflt,netadp,drv}; do
    if grep -q "^${module}" /proc/modules; then
      stat_fail
      return 1
    fi
  done
  stat_done
}

remove() {
  stat_busy "Removing VirtualBox kernel modules"
  'rm' -f "/lib/modules/$(uname -r)/misc/"{vboxdrv,vboxnetadp,vboxnetflt}.ko
  stat_done
}

setup() {
  remove
  stat_busy "Compiling VirtualBox kernel modules"
  LOG="/tmp/vbox-install.log"
  if ! $BUILDVBOXDRV \
    --save-module-symvers /tmp/vboxdrv-Module.symvers \
    --no-print-directory install > $LOG 2>&1; then
    echo  "Look at $LOG to find out what went wrong"
  fi
  if ! $BUILDVBOXNETFLT \
    --use-module-symvers /tmp/vboxdrv-Module.symvers \
    --no-print-directory install >> $LOG 2>&1; then
    echo "Look at $LOG to find out what went wrong"
  fi
  if ! $BUILDVBOXNETADP \
    --use-module-symvers /tmp/vboxdrv-Module.symvers \
    --no-print-directory install >> $LOG 2>&1; then
    echo "Look at $LOG to find out what went wrong"
  fi
  stat_done
}

case "$1" in
  start)
    load
    ;;
  stop)
      unload
      ;;
  restart)
      unload
      load
      ;;
  setup)
    setup
    ;;
  remove)
    remove
    ;;
  *)
    echo "usage: $0 {start|stop|restart|setup|remove}"
esac

# vim:set ts=2 sw=2 ft=sh et:
